function formatInt(e,t){for(var a=""+e;a.length<t;)a="0"+a;return a}function fixDataMess(e){for(var t=[],a=2,r="filename";e.hasOwnProperty(r);)t.push(e[r]),r="track"+formatInt(a++,2);return t}function getFileExtension(e){return e.match(/\.[0-9a-z]+$/i)}function prettifyTrack(e,t){return e.replace(t.artist,"").replace(" - ","").replace(/\.(mp3|flac)$/,"").replace(/^[0-9]+ +/,"")}function renderPlaylistFilesHTML(e,t,a){a.empty();var r=1,i=secondsToPrettyString(parseInt(t.runtime),!0);if(e.length>1&&(i=""),e.forEach(function(e){if("preview"!=e.type&&"extra"!=e.type){console.log(e),a.append("<tr><td>"+r++ +"</td><td>"+(e.dname?e.dname:e.fname)+"</td><td>"+(t.artist?t.artist:"")+"</td><td>"+(e.runtime?secondsToPrettyString(parseInt(e.runtime),!0):"")+'</td><td><span class="price">$<span class="price tb-price-play">'+(e.sugPlay?e.sugPlay:"Free!")+'</span></span></td><td><span class="price">$<span class="price tb-price-download"><span>'+(e.sugBuy?e.sugBuy:"Free!")+"</span></span></td></tr>");var i=a.children().last();i.data({track:e,name:name,url:IPFSUrl([t["DHT Hash"],e.fname]),sugPlay:e.sugPlay,minPlay:e.minPlay,sugBuy:e.sugBuy,minBuy:e.minBuy})}}),$(".playlist-tracks tr").on("click",function(e){var t=$(this),a=t.data();loadTrack(a.name,a.url),$(".playlist-tracks tr").removeClass("selected"),t.addClass("selected")}),$(".tb-price-play",a).on("click",showPaymentOption),$(".tb-price-download",a).on("click",showPaymentOption),e[0].sugPlay)togglePlaybarShadow(!1);else{togglePlaybarShadow(!0);var n=setTimeout("autoPlayFree()",500)}}function autoPlayFree(){$(".playlist-tracks tr:first").click()}function secondsToPrettyString(e,t){var a=moment.duration(e,"s"),r=a.seconds()<10?"0"+a.seconds():a.seconds();return t?a.minutes()+":"+r:a.minutes()+" minutes "+r+" seconds"}function getPrices(e){var t={play:{suggested:0,min:0},download:{suggested:0,min:0}};return e.minBuy&&(t.download.min=e.minBuy),e.sugBuy&&(t.download.suggested=e.sugBuy),e.minPlay&&(t.play.min=e.minPlay),e.sugPlay&&(t.play.suggested=e.sugPlay),t}function togglePlaybarShadow(e){$(".playbar-shadow").toggleClass("hidden",e),$(".buybox").toggleClass("hidden",e)}function applyMediaData(e){var t=e["alexandria-media"],a=t.info,r=a["extra-info"];filetype=r.filename.split(".")[r.filename.split(".").length-1].toLowerCase();var i=t.payment,n=r["DHT Hash"],o=$(".media-info"),s=$(".release-info"),l=$(".media-data"),c=fixDataMess(r);mainFile={track:r.files[0],name:r.files[0].dname,url:IPFSUrl([r["DHT Hash"],r.files[0].fname]),sugPlay:r.files[0].sugPlay,minPlay:r.files[0].minPlay,sugBuy:r.files[0].sugBuy,minBuy:r.files[0].minBuy},l.data(t),$(".pwyw-price-play").text(r.files[0].sugPlay),$(".pwyw-price-suggest-play").text(r.files[0].sugPlay),$(".pwyw-price-download").text(r.files[0].sugBuy),$(".pwyw-price-suggest-download").text(r.files[0].sugBuy),$(".media-artist",o).text(r.artist?r.artist:""),$(".media-title",o).text(a.title),$(".ri-runtime",s).text(secondsToPrettyString(parseInt(r.runtime))),$(".ri-audio-count",s).text(c.length),$(".ri-publisher",s).text(t.publisher),$(".ri-btc-address",s).text(r["Bitcoin Address"]),r.coverArt?($(".playbar-shadow").css("width","initial"),$(".media-cover img").attr("src",IPFSUrl([n,r.coverArt])),$(".media-cover").show()):($(".media-cover").hide(),$(".playbar-shadow").css("width","100%")),renderPlaylistFilesHTML(r.files,r,$(".playlist-tracks")),keepHash=t.torrent,console.log(t,c);var p=t.timestamp;return 10==p.toString().length&&(p=1e3*t.timestamp),$(".ri-date").text(moment(p).format("MMMM Do YYYY")),$(".media-description").text(a.description),watchForPin(n,r.filename),t}function watchForPin(e,t){window.pinWatcher&&clearInterval(window.pinWatcher);var a=$(".pwyw-currently-pinning");window.pinWatcher=setInterval(function(){},2e3)}function IPFSUrl(e){return encodeURI(IPFSHost+"/"+e.join("/"))}function showPaymentOption(e){var t=this,a=$(this).parent().parent().parent().data();console.log(a),jQuery.isEmptyObject(a)&&(a=mainFile),console.log(a);var r=$(".ri-btc-address").text(),i=0,n,o;if($(".pwyw-item").removeClass("active"),($(this).hasClass("tb-price-play")||$(this).hasClass("pwyw-action-play"))&&(n=$(".pwyw-activate-play"),o="play",i=a.sugPlay),($(this).hasClass("tb-price-download")||$(this).hasClass("pwyw-action-download"))&&(n=$(".pwyw-activate-download"),o="download",i=a.sugBuy),n.hasClass("active"))return $(".pwyw-container").removeClass("active");if(0===i||void 0===i||NaN==i)return void onPaymentDone(o,a);var s=makePaymentToAddress(r,i,function(){return onPaymentDone(o,a)});$(".pwyw-btc-"+o+"-price").text(s),$(".pwyw-usd-"+o+"-price-input").val(i),$(".pwyw-container").removeClass("active"),n.addClass("active"),togglePWYWOverlay(!0)}function mountMediaBrowser(e,t){var a=t[0]["publisher-name"],r=t[0].txid,t=t[0]["media-data"];$(e).html($("#media-template").html());var i=applyMediaData(t);getUSDdayAvg(),"mp3"==filetype||"m4a"==filetype?$("#audio-player").jPlayer({cssSelectorAncestor:"#playbar-container",swfPath:"/js",supplied:filetype,useStateClassSkin:!0,autoBlur:!1,smoothPlayBar:!0,keyEnabled:!0,remainingDuration:!0,toggleDuration:!0,error:function(e){console.error("got jplayer error",e)}}):"mp4"==filetype||"m4v"==filetype?$("#audio-player").jPlayer({cssSelectorAncestor:"#playbar-container",swfPath:"/js",supplied:"m4v",size:{width:"820px",height:"547px"},useStateClassSkin:!0,autoBlur:!1,smoothPlayBar:!0,keyEnabled:!0,remainingDuration:!0,toggleDuration:!0,error:function(e){console.error("got jplayer error",e)}}):"webm"==filetype?$("#audio-player").jPlayer({cssSelectorAncestor:"#playbar-container",swfPath:"/js",supplied:"webmv",size:{width:"820px",height:"547px"},useStateClassSkin:!0,autoBlur:!1,smoothPlayBar:!0,keyEnabled:!0,remainingDuration:!0,toggleDuration:!0,error:function(e){console.error("got jplayer error",e)}}):$(".jp-title").text("Unsupported File Format"),$(".pwyw-usd-price-input").on("keyup",function(e){var t=this.classList[1].replace(/^pwyw-usd-/,"").replace(/-price-input$/,"");$(".pwyw-btc-"+t+"-price").text(USDToBTC(this.value)),lastAddress&&setQR(lastAddress,USDToBTC(this.value))}),$(".pwyw-item").on("click",showPaymentOption),$(".pwyw-overlay").on("click",function(){$(".pwyw-item.active").trigger("click"),$(".pwyw-container.active").removeClass("active"),togglePWYWOverlay(!1)}),$(".pwyw-close").on("click",function(){$(".pwyw-item.active").trigger("click"),$(".pwyw-container.active").removeClass("active"),togglePWYWOverlay(!1)}),$(".pwyw-pin-it").on("click",function(e){$.ajax({url:"http://localhost:8079/api/ipfs/pin/add/"+keepHash}).done(function(e){"ok"==e.status?(togglePlaybarShadow(!0),$(".pwyw-close").trigger("click")):"error"==e.status&&e.error.indexOf("already pinned recursively")>-1?(togglePlaybarShadow(!0),$(".pwyw-close").trigger("click")):$(".pwyw-pining-error").text("An unknown error has occured, please make sure you have Librarian installed and running.").show()}).fail(function(){$(".pwyw-pining-error").text("You must have Librarian installed and running in order to use this feature.").show()})}),$(".format-selector button").on("click",function(e){filetype=$(e.target).html(),$(".format-selector button").removeClass("active"),$(this).addClass("active")});var n={currentView:"artifact",searchResults:!1,subView:r,artifactTitle:i.info.title,mediaType:i.type,artifactPublisher:a,publisherId:i.publisher};makeHistory(n,"ΛLΞXΛNDRIΛ > Media > "+n.mediaType.charAt(0).toUpperCase()+n.mediaType.slice(1)+" > "+n.artifactTitle)}function USDTouBTC(e){return(1e6*Number(e)/day_avg).toString().substring(0,16)}function USDToBTC(e){return Math.round(1e8*(Number(e)/day_avg).toString().substring(0,16))/1e8}function BTCtoUSD(e){return Math.round(100*(Number(e)*day_avg).toString().substring(0,16))/100}function loadTrack(e,t){console.log(t),console.log(filetype),"mp3"==filetype||"m4a"==filetype?$("#audio-player").jPlayer("setMedia",{title:e,mp3:t}):"mp4"==filetype||"m4v"==filetype?($("#audio-player").jPlayer("setMedia",{title:e,m4v:t}),$("#audio-player").slideDown("slow")):"webm"==filetype?($("#audio-player").jPlayer("setMedia",{title:e,webmv:t}),$("#audio-player").slideDown("slow")):"mov"==filetype&&$("#playbar-container").hide().after('<video id="native-player" controls="controls" poster=""><source src="'+t+'" /><param name="autoplay" value="true" /></video>'),0==$(".playbar-shadow:visible").length&&$("#audio-player").jPlayer("play")}function togglePWYWOverlay(e){var t=e?"show":"hide";$(".pwyw-close")[t](),$(".pwyw-overlay")[t]()}function onPaymentDone(e,t){var a=t.url;console.log(t),console.log(t.track),console.log(t.track.fname),resetQR(),"pin"==e&&$(".pwyw-pining-error").hide(),"pin"!=e&&($(".pwyw-container.active").removeClass("active"),togglePWYWOverlay(!1),togglePlaybarShadow(!0));var r=loadTrack(t.track.fname,a);if("download"===e){var i=$("<a>").attr("href",a).attr("download",t.track.fname).appendTo("body");i[0].click(),i.remove()}$("#audio-player").jPlayer("play")}function makePaymentToAddress(e,t,a){resetQR(),togglePlaybarShadow(!1);var r=USDToBTC(t),i={address:e,amount:r};return $.ajax({url:URL_RECV,data:i}).done(function(e,r,i){console.log(e.input_address),lastAddress=e.input_address,setQR(e.input_address,USDToBTC(t)),watchForpayment(e.input_address,t,a)}).fail(function(e,t,a){console.error(t)}),USDToBTC(t)}function getUSDdayAvg(){$.ajax({url:"https://api.bitcoinaverage.com/ticker/global/USD/"}).done(function(e){day_avg=e["24h_avg"]})}function watchForpayment(e,t,a){return a=a||function(){},0>=t?a(t):void $.ajax({url:URL_GETRECVD+e}).done(function(r){if(!day_avg)return paymentTimeout&&clearTimeout(paymentTimeout),paymentTimeout=setTimeout(function(){watchForpayment(e,t,a)},delay),!1;var i=BTCtoUSD(r);console.log(i);var n=t;return n>i?(paymentTimeout&&clearTimeout(paymentTimeout),paymentTimeout=setTimeout(function(){watchForpayment(e,t,a)},delay),!0):(console.log("payed."),togglePlaybarShadow(!0),void a(i))})}function resetQR(){$(".pwyw-qrcode img").attr("src","data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///ywAAAAAAQABAAACAUwAOw=="),$(".pwyw-btc-address").text("")}function setQR(e,t){if(t){var a="http://api.qrserver.com/v1/create-qr-code/?size=300x300&data=bitcoin:"+e+"?amount="+t;$(".pwyw-qrcode img").attr("src",a),$(".pwyw-btc-address").text(e)}}var filetype="mp3",day_avg=!1,delay=5e3,keepHash,mainFile,URL_RECV="http://192.241.219.201:11306/payproc/api/receive",URL_GETRECVD="http://192.241.219.201:11306/payproc/api/getreceivedbyaddress/";window.doMountMediaBrowser=function(e,t){return console.log(e,t),$(".media-cover img").attr("src",""),$("#audio-player").slideUp(),mountMediaBrowser(e,t)};var lastAddress,paymentTimeout;